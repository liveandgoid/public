<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L’ORÉAL MIP - Indonesia Edition</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ------------------------------------------------------------------
           THEME & VARIABLES
           ------------------------------------------------------------------ */
        :root {
            --color-gold: #C6A664;
            --color-gold-dim: #8a7344;
            --color-bg-dark: #0a0a0a;
            --color-bg-panel: #141414;
            --color-bg-panel-hover: #1f1f1f;
            --color-text-primary: #ffffff;
            --color-text-secondary: #a0a0a0;
            --color-border: #333333;
            --color-success: #4caf50;
            --color-danger: #f44336;
            
            --font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            --sidebar-width: 240px;
            --header-height: 70px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
        }

        /* ------------------------------------------------------------------
           LAYOUT & SIDEBAR
           ------------------------------------------------------------------ */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* SIDEBAR */
        aside {
            width: var(--sidebar-width);
            background-color: var(--color-bg-panel);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
            transition: width 0.3s ease, transform 0.3s ease;
            white-space: nowrap; /* Prevent text wrap when collapsing */
            overflow: hidden;
        }

        /* Desktop Collapse State */
        aside.desktop-hidden {
            width: 0;
            border-right: none;
        }

        .brand-logo {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--color-border);
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--color-text-primary);
            min-width: var(--sidebar-width); /* Keep logo layout stable */
        }
        .brand-logo span { color: var(--color-gold); margin-right: 5px; }

        nav {
            flex: 1;
            padding: var(--spacing-md) 0;
            overflow-y: auto;
            min-width: var(--sidebar-width); /* Keep nav items layout stable */
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: var(--color-text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            background-color: var(--color-bg-panel-hover);
        }

        .nav-item.active {
            color: var(--color-gold);
            background-color: rgba(198, 166, 100, 0.05);
            border-left: 3px solid var(--color-gold);
        }

        .nav-item i { width: 24px; margin-right: 10px; }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 90;
            display: none;
        }

        /* MAIN CONTENT */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            width: 100%; /* Ensure full width */
        }

        /* HEADER */
        header {
            height: var(--header-height);
            background-color: var(--color-bg-panel);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-lg);
            flex-shrink: 0;
        }

        .header-left-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle-btn {
            background: none;
            border: none;
            color: var(--color-gold);
            font-size: 20px;
            cursor: pointer;
            display: block; /* Visible on desktop now */
        }

        .header-left h1 {
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .header-left h2 {
            font-size: 12px;
            color: var(--color-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 2px;
        }

        /* Mobile Title (Hidden by default) */
        .mobile-title {
            display: none;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }
        .mobile-title span { color: var(--color-gold); }

        .header-controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        select, input[type="date"] {
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            padding: 6px 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer; 
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); 
            opacity: 0.6;
            cursor: pointer;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        select:focus, input:focus {
            border-color: var(--color-gold);
        }

        /* CHECKBOX GROUP STYLE */
        .checkbox-group {
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            padding: 6px 12px;
            border-radius: 4px;
            height: 30px; /* Match height of select inputs approximately */
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--color-text-secondary);
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-group input[type="checkbox"] {
            accent-color: var(--color-gold);
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .btn-gold {
            background-color: transparent;
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-gold:hover {
            background-color: var(--color-gold);
            color: #000;
        }
        
        .btn-gold.active {
            background-color: var(--color-gold);
            color: #000;
        }

        /* PAGE CONTENT AREA */
        #content-area {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
            background-color: var(--color-bg-dark);
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .page-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ------------------------------------------------------------------
           COMPONENTS
           ------------------------------------------------------------------ */
        
        /* AI INSIGHT PANEL */
        .ai-panel {
            background: linear-gradient(90deg, rgba(198, 166, 100, 0.1) 0%, rgba(10,10,10,0) 100%);
            border-left: 4px solid var(--color-gold);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            border-radius: 0 4px 4px 0;
        }
        .ai-title {
            color: var(--color-gold);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-content ul {
            list-style: none;
            padding-left: var(--spacing-md);
        }
        .ai-content li {
            position: relative;
            margin-bottom: 4px;
            color: var(--color-text-secondary);
            font-size: 13px;
        }
        .ai-content li::before {
            content: "•";
            color: var(--color-gold);
            position: absolute;
            left: -12px;
        }

        /* REDESIGNED KPI SCORECARDS */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .card {
            background: linear-gradient(145deg, var(--color-bg-panel) 0%, #151515 100%);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            min-height: 150px;
            transition: transform 0.2s, border-color 0.2s;
        }

        /* Compact Card */
        .card-compact {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            min-height: 100px;
        }
        .card-compact .kpi-value {
            font-size: 20px;
            margin-bottom: 8px;
        }
        .card-compact .kpi-title {
            font-size: 10px;
            margin-bottom: 4px;
        }
        .card-compact .sparkline-canvas {
            width: 50px;
            height: 25px;
        }

        .card:hover, .card-compact:hover {
            transform: translateY(-2px);
            border-color: #444;
        }

        /* Typography */
        .kpi-title {
            color: var(--color-text-secondary);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .kpi-value {
            color: var(--color-text-primary);
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
            line-height: 1;
        }
        .kpi-value.gold { 
            color: var(--color-gold); 
            text-shadow: 0 0 15px rgba(198, 166, 100, 0.2);
        }

        .kpi-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: auto;
        }

        .kpi-growth {
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
        }
        .growth-up { color: var(--color-success); }
        .growth-down { color: var(--color-danger); }
        
        .kpi-subtext { 
            font-size: 10px; 
            color: #555; 
            margin-top: 2px; 
            display: block; 
            font-weight: 500;
        }

        .sparkline-canvas {
            width: 80px;
            height: 35px;
            opacity: 0.8;
        }

        /* CHARTS */
        .chart-section {
            background-color: var(--color-bg-panel);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: var(--spacing-sm);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .chart-controls, .period-toggles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            padding: 4px 8px;
        }
        .toggle-btn.active {
            color: var(--color-gold);
            font-weight: 700;
            border-bottom: 2px solid var(--color-gold);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
        }
        
        .chart-canvas-wrapper {
            height: 100%;
            width: 100%;
            min-width: 0; 
            position: relative;
        }

        /* TABLES */
        .table-section {
            background-color: var(--color-bg-panel);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            overflow-x: auto; /* Allow table scrolling */
            display: flex;
            flex-direction: column;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 600px; /* Force scroll on small screens */
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-size: 11px;
            border-bottom: 1px solid var(--color-border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #252525;
            color: var(--color-text-primary);
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: rgba(255,255,255,0.02); }
        
        .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        .clickable-row:hover {
            background-color: rgba(198, 166, 100, 0.1) !important;
        }
        .clickable-row:hover td {
            color: var(--color-gold);
        }

        .rank-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #333;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        .rank-1 { background-color: var(--color-gold); color: #000; }
        .rank-2 { background-color: #A9A9A9; color: #000; }
        .rank-3 { background-color: #CD7F32; color: #000; }

        /* GRIDS */
        .split-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .split-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .division-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        /* Updated Division Card for Selection */
        .division-card {
            background: linear-gradient(135deg, var(--color-bg-panel) 0%, #1a1a1a 100%);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-gold);
            padding: var(--spacing-md);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .division-card:hover {
            transform: translateY(-2px);
            border-color: #555;
        }

        .division-card.selected {
            border: 1px solid var(--color-gold);
            background: linear-gradient(135deg, rgba(198, 166, 100, 0.15) 0%, #1a1a1a 100%);
            box-shadow: 0 0 15px rgba(198, 166, 100, 0.1);
        }

        /* Custom Checkbox for Division Card */
        .card-checkbox {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 18px;
            height: 18px;
            border: 1px solid #555;
            border-radius: 3px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Clicking card triggers it */
        }
        
        .division-card.selected .card-checkbox {
            background: var(--color-gold);
            border-color: var(--color-gold);
        }
        
        .division-card.selected .card-checkbox::after {
            content: '✔';
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }

        .div-title { font-size: 12px; color: var(--color-text-secondary); text-transform: uppercase; margin-bottom: 10px;}
        .div-stat { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; color: #888; }
        .div-stat span:last-child { font-weight: 600; color: #fff; }
        
        /* Specific metric styles inside division card */
        .div-metric-lg {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal {
            background-color: var(--color-bg-panel);
            width: 600px;
            border: 1px solid var(--color-gold);
            border-radius: 6px;
            padding: var(--spacing-lg);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 90%;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--color-border); padding-bottom: 10px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-size: 11px; color: var(--color-text-secondary); margin-bottom: 4px; }
        .form-group input { width: 100%; padding: 8px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; }
        .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1400px) {
            .kpi-value { font-size: 28px; }
        }
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr) !important; }
            .split-grid { grid-template-columns: 1fr; }
            .division-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Mobile Layout */
        @media (max-width: 768px) {
            aside { 
                position: fixed; 
                height: 100vh;
                left: 0; top: 0;
                transform: translateX(-100%);
                box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            }
            aside.sidebar-open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            header { 
                padding: 0 15px; 
                justify-content: space-between;
                gap: 10px;
                flex-wrap: wrap; 
                height: auto; 
                min-height: 70px;
            }
            
            .header-left { display: none; } 
            .mobile-title { display: block; } 

            .header-controls {
                display: flex; 
                width: 100%;
                flex-wrap: wrap;
                padding-bottom: 10px;
                justify-content: center;
            }
            
            .kpi-grid { grid-template-columns: 1fr 1fr !important; }
            
            .card { padding: 15px; min-height: 120px; }
            .kpi-value { font-size: 20px; }
            
            .chart-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .chart-controls { overflow-x: auto; width: 100%; padding-bottom: 5px; }
            
            .modal-grid { grid-template-columns: 1fr; }
        }

        /* Utility */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

    </style>
</head>
<body>

<div id="app-container">
    <!-- MOBILE OVERLAY -->
    <div class="sidebar-overlay" onclick="app.toggleSidebar()"></div>

    <!-- SIDE MENU -->
    <aside id="sidebar">
        <div class="brand-logo">
            <span>L’ORÉAL</span> MIP
        </div>
        <nav>
            <div class="nav-item active" onclick="app.router('dashboard', this)">
                <i class="fa-solid fa-chart-line"></i> Executive Overview
            </div>
            <div class="nav-item" onclick="app.router('livestream', this)">
                <i class="fa-solid fa-video"></i> Livestream
            </div>
            <div class="nav-item" onclick="app.router('shortvideo', this)">
                <i class="fa-brands fa-tiktok"></i> Short Video
            </div>
            <!-- MENU AFFILIATE HIDDEN -->
            <div class="nav-item" onclick="app.router('affiliates', this)" style="display: none;">
                <i class="fa-solid fa-users"></i> Affiliates
            </div>
            <div class="nav-item" onclick="app.router('brands', this)">
                <i class="fa-solid fa-bag-shopping"></i> Brands
            </div>
            <div class="nav-item" onclick="app.router('skus', this)">
                <i class="fa-solid fa-barcode"></i> SKUs
            </div>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        <!-- HEADER -->
        <header>
            <div class="header-left-container">
                <!-- Hamburger Button Visible on Desktop & Mobile -->
                <button class="menu-toggle-btn" onclick="app.toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="header-left">
                    <h1>Monetization Intelligence Platform</h1>
                    <h2>Indonesia Edition</h2>
                </div>
                <div class="mobile-title">
                    <span>L’ORÉAL</span> MIP
                </div>
            </div>
            
            <div class="header-controls">
                <!-- PLATFORM CHECKBOX GROUP -->
                <div class="checkbox-group">
                    <label><input type="checkbox" value="tiktok" checked> TikTok</label>
                    <label><input type="checkbox" value="shopee" checked> Shopee</label>
                </div>

                <select id="divisionFilter">
                    <option value="all">All Divisions</option>
                    <option value="CPD">Consumer (CPD)</option>
                    <option value="LLD">Luxe (LLD)</option>
                    <option value="PPD">Professional (PPD)</option>
                    <option value="LDB">Dermatological (LDB)</option>
                </select>
                
                <!-- NEW BRAND FILTER -->
                <select id="brandFilter">
                    <option value="all">All Brands</option>
                </select>

                <div style="display:flex; gap:4px; align-items:center;">
                    <input type="date" id="startDate" value="2024-01-01">
                    <span style="color:#666">-</span>
                    <input type="date" id="endDate" value="2024-01-31">
                </div>
                <button class="btn-gold" onclick="app.applyFilters()">APPLY</button>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <div id="content-area">
            <!-- PAGE 1: DASHBOARD -->
            <div id="dashboard" class="page-section active">
                <div class="ai-panel">
                    <div class="ai-title"><i class="fa-solid fa-robot"></i> AI Executive Insight Summary</div>
                    <div class="ai-content">
                        <ul>
                            <li>GMV per Hour increased by 12% driven by LLD flagship events on TikTok Shop.</li>
                            <li>Short Video contribution is rising steadily (+5% WoW) due to new KOL partnerships.</li>
                            <li>Maybelline Super Stay launch campaign drove a 45% spike in orders on Tuesday.</li>
                            <li>Live session duration correlates positively with AOV; sessions >2 hours show 15% higher AOV.</li>
                        </ul>
                    </div>
                </div>
                <div class="kpi-grid" id="dash-kpi-row" style="grid-template-columns: repeat(6, 1fr);"></div>
                <div class="chart-section">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.updateChart('dash-main', 'GMV')">GMV Trend</button>
                            <button class="btn-gold" onclick="app.updateChart('dash-main', 'GMV_HOUR')">GMV/Hr</button>
                            <button class="btn-gold" onclick="app.updateChart('dash-main', 'ORDERS')">Orders</button>
                            <button class="btn-gold" onclick="app.updateChart('dash-main', 'VIEWS')">Views</button>
                        </div>
                        <div class="period-toggles">
                            <button class="toggle-btn active" onclick="app.setPeriod('daily')">Daily</button>
                            <button class="toggle-btn" onclick="app.setPeriod('weekly')">Weekly</button>
                            <button class="toggle-btn" onclick="app.setPeriod('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper" id="dashMainWrapper">
                            <canvas id="dashMainChart"></canvas>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom:8px; font-size:11px; text-transform:uppercase; color:#666; font-weight:600;">Channel Contribution</div>
                <!-- Channel Contribution Grid - Now only 2 items -->
                <div class="split-grid-2" id="channel-kpi-row"></div>
                
                <div class="split-grid" style="margin-top: 24px;">
                     <div class="table-section" style="margin-bottom:0; padding:0;">
                         <div style="padding:15px; border-bottom:1px solid #333; font-weight:600; color:var(--color-gold);">TOP 5 BRANDS</div>
                         <table id="dash-top-brands"><thead><tr><th>Rank</th><th>Brand</th><th>GMV</th></tr></thead><tbody></tbody></table>
                     </div>
                     <div class="table-section" style="margin-bottom:0; padding:0;">
                         <div style="padding:15px; border-bottom:1px solid #333; font-weight:600; color:var(--color-gold);">TOP 5 CREATORS</div>
                         <table id="dash-top-creators"><thead><tr><th>Rank</th><th>Creator</th><th>GMV</th></tr></thead><tbody></tbody></table>
                     </div>
                     <div class="table-section" style="margin-bottom:0; padding:0;">
                         <div style="padding:15px; border-bottom:1px solid #333; font-weight:600; color:var(--color-gold);">LATEST SESSIONS</div>
                         <table id="dash-latest-sessions"><thead><tr><th>Host / Brand</th><th>GMV</th><th>GMV/Hr</th></tr></thead><tbody></tbody></table>
                     </div>
                </div>
            </div>

            <!-- PAGE 2: LIVESTREAM -->
            <div id="livestream" class="page-section">
                <!-- Content same as before -->
                <div class="ai-panel">
                    <div class="ai-title"><i class="fa-solid fa-robot"></i> AI Livestream Insight</div>
                    <div class="ai-content">
                        <ul>
                            <li>Peak viewer retention occurs between 19:00 - 21:00 WIB across all platforms.</li>
                            <li>"Flash Sale" overlay mechanics increased CTR by 3.4% in CPD streams.</li>
                        </ul>
                    </div>
                </div>
                <div class="kpi-grid" id="live-kpi-row" style="grid-template-columns: repeat(6, 1fr);"></div>
                <div class="ai-panel" style="margin-top: 20px;">
                    <div class="ai-title"><i class="fa-solid fa-chart-pie"></i> Engagement & Performance Deep Dive</div>
                    <div id="live-engagement-kpis" class="kpi-grid" style="grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 0;"></div>
                </div>
                <div class="chart-section">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.updateLiveChart('GMV')">GMV</button>
                            <button class="btn-gold" onclick="app.updateLiveChart('GMV_HOUR')">GMV/Hr</button>
                            <button class="btn-gold" onclick="app.updateLiveChart('ORDERS')">Orders</button>
                            <button class="btn-gold" onclick="app.updateLiveChart('VIEWS')">Views</button>
                            <button class="btn-gold" onclick="app.updateLiveChart('ENGAGEMENT')">Engagement</button>
                        </div>
                        <div class="period-toggles">
                            <button class="toggle-btn active" onclick="app.setLivePeriod('daily')">Daily</button>
                            <button class="toggle-btn" onclick="app.setLivePeriod('weekly')">Weekly</button>
                            <button class="toggle-btn" onclick="app.setLivePeriod('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper" id="liveChartWrapper">
                            <canvas id="liveMainChart"></canvas>
                        </div>
                    </div>
                </div>
                <br>
                <div class="chart-section" style="padding-bottom:0;">
                    <div class="chart-header" style="border:none;">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.switchLiveTab('division')">By Division</button>
                            <button class="btn-gold" onclick="app.switchLiveTab('brand')">By Brand</button>
                            <button class="btn-gold" onclick="app.switchLiveTab('host')">By Host</button>
                            <button class="btn-gold" onclick="app.switchLiveTab('all')">All Sessions</button>
                        </div>
                    </div>
                </div>
                <div class="table-section">
                    <div id="live-tab-division" class="live-tab-content"><table id="table-live-division"><thead><tr><th>Division</th><th>Sessions</th><th>Hours</th><th>GMV</th><th>GMV/Hr</th><th>Growth</th></tr></thead><tbody></tbody></table></div>
                    <div id="live-tab-brand" class="live-tab-content hidden"><table id="table-live-brand"><thead><tr><th>Brand</th><th>Div</th><th>Sessions</th><th>Hours</th><th>GMV</th><th>GMV/Hr</th><th>Orders</th><th>Growth</th></tr></thead><tbody></tbody></table></div>
                    <div id="live-tab-host" class="live-tab-content hidden"><table id="table-live-host"><thead><tr><th>Host</th><th>Sessions</th><th>Hours</th><th>GMV</th><th>Views</th><th>RPM</th><th>Engage Score</th></tr></thead><tbody></tbody></table></div>
                    <div id="live-tab-all" class="live-tab-content hidden"><div style="padding:10px; display:flex; justify-content:flex-end;"><input type="text" placeholder="Search Session ID..." style="background:#000; border:1px solid #333; padding:5px; color:#fff;"></div><table id="table-live-all"><thead><tr><th>Date</th><th>Brand</th><th>Host</th><th>Dur</th><th>GMV</th><th>GMV/Hr</th><th>Views</th><th>Comms</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <!-- PAGE 3: SHORT VIDEO -->
            <div id="shortvideo" class="page-section">
                <!-- Content same as before -->
                <div class="ai-panel">
                    <div class="ai-title"><i class="fa-solid fa-robot"></i> AI Short Video Insight</div>
                    <div class="ai-content">
                        <ul><li>Shorts featuring "Tutorial" content format yield 2x higher AOV than "Entertainment" format.</li></ul>
                    </div>
                </div>
                <div class="kpi-grid" id="video-kpi-row" style="grid-template-columns: repeat(6, 1fr);"></div>
                <div class="chart-section">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.updateVideoChart('GMV')">GMV</button>
                            <button class="btn-gold" onclick="app.updateVideoChart('GMV_HOUR')">GMV/Hr</button>
                            <button class="btn-gold" onclick="app.updateVideoChart('ORDERS')">Orders</button>
                            <button class="btn-gold" onclick="app.updateVideoChart('VIEWS')">Views</button>
                            <button class="btn-gold" onclick="app.updateVideoChart('ENGAGEMENT')">Engagement</button>
                        </div>
                        <div class="period-toggles">
                            <button class="toggle-btn active" onclick="app.setVideoPeriod('daily')">Daily</button>
                            <button class="toggle-btn" onclick="app.setVideoPeriod('weekly')">Weekly</button>
                            <button class="toggle-btn" onclick="app.setVideoPeriod('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper" id="videoChartWrapper">
                            <canvas id="videoMainChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-section" style="padding-bottom:0;">
                    <div class="chart-header" style="border:none;">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.switchShortVideoTab('brand')">By Brand</button>
                            <button class="btn-gold" onclick="app.switchShortVideoTab('creator')">By Creator</button>
                            <button class="btn-gold" onclick="app.switchShortVideoTab('platform')">By Platform</button>
                        </div>
                    </div>
                </div>
                <div class="table-section">
                    <div id="video-tab-brand" class="video-tab-content"><table id="table-video-brand"><thead><tr><th>Brand</th><th>Videos Posted</th><th>Total Views</th><th>Likes</th><th>Shares</th><th>GMV</th><th>Engage Rate</th></tr></thead><tbody></tbody></table></div>
                    <div id="video-tab-creator" class="video-tab-content hidden"><table id="table-video-creator"><thead><tr><th>Creator</th><th>Videos</th><th>Total Views</th><th>GMV</th><th>Engagement Score</th></tr></thead><tbody></tbody></table></div>
                    <div id="video-tab-platform" class="video-tab-content hidden"><table id="table-video-platform"><thead><tr><th>Platform</th><th>Total Views</th><th>GMV</th><th>Orders</th><th>Avg CTR</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <!-- PAGE 4: AFFILIATES (HIDDEN IN MENU, BUT CODE EXISTS) -->
            <div id="affiliates" class="page-section">
                <!-- Content same as before -->
                <div class="ai-panel">
                    <div class="ai-title"><i class="fa-solid fa-robot"></i> AI Affiliate Insight</div>
                    <div class="ai-content">
                        <ul><li>Top 10 Creators drive 60% of Affiliate GMV. Recommended: Exclusive bundle offers for Top Tier.</li></ul>
                    </div>
                </div>
                <div class="kpi-grid" id="affiliate-kpi-row" style="grid-template-columns: repeat(5, 1fr);"></div>
                <div class="chart-section">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.updateAffiliateChart('GMV')">GMV Trend</button>
                            <button class="btn-gold" onclick="app.updateAffiliateChart('ORDERS')">Orders Trend</button>
                            <button class="btn-gold" onclick="app.updateAffiliateChart('RPM')">RPM Trend</button>
                        </div>
                        <div class="period-toggles">
                            <button class="toggle-btn active" onclick="app.setAffiliatePeriod('daily')">Daily</button>
                            <button class="toggle-btn" onclick="app.setAffiliatePeriod('weekly')">Weekly</button>
                            <button class="toggle-btn" onclick="app.setAffiliatePeriod('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper" id="affiliateChartWrapper">
                            <canvas id="affiliateMainChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="table-section">
                    <div class="chart-title" style="margin-bottom:15px; display:flex; justify-content:space-between;">
                        <span>Top Creator Performance</span>
                        <button class="btn-gold">Export CSV</button>
                    </div>
                    <table id="table-affiliates"><thead><tr><th>Rank</th><th>Creator</th><th>Platform</th><th>GMV</th><th>Orders</th><th>Comm %</th><th>RPM</th><th>Growth</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <!-- PAGE 5: BRANDS -->
            <div id="brands" class="page-section">
                <!-- Content same as before -->
                <div class="ai-panel">
                    <div class="ai-title"><i class="fa-solid fa-robot"></i> AI Brand Insight</div>
                    <div class="ai-content">
                        <ul><li>LDB Division showing highest YoY Growth (+22%) due to CeraVe viral trends.</li></ul>
                    </div>
                </div>
                
                <!-- NEW POSITION: DIVISION FILTER CARDS (FIRST) -->
                <div class="division-grid" id="brand-division-cards" style="margin-bottom: 20px;"></div>

                <!-- KPI ROW (SECOND - SECONDARY) -->
                <div class="kpi-grid" id="brand-kpi-row" style="grid-template-columns: repeat(5, 1fr);"></div>

                <!-- CHART -->
                <div class="chart-section">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button class="btn-gold active" onclick="app.updateBrandChart('GMV')">GMV Trend</button>
                            <button class="btn-gold" onclick="app.updateBrandChart('GMV_HOUR')">GMV/HR</button>
                            <button class="btn-gold" onclick="app.updateBrandChart('ORDERS')">Orders</button>
                            <button class="btn-gold" onclick="app.updateBrandChart('SESSIONS')">Sessions</button>
                            <button class="btn-gold" onclick="app.updateBrandChart('HOURS')">Hours</button>
                        </div>
                        <div class="period-toggles">
                            <button class="toggle-btn active" onclick="app.setBrandPeriod('daily')">Daily</button>
                            <button class="toggle-btn" onclick="app.setBrandPeriod('weekly')">Weekly</button>
                            <button class="toggle-btn" onclick="app.setBrandPeriod('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-canvas-wrapper" id="brandChartWrapper">
                            <canvas id="brandMainChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TABLE -->
                <div class="table-section">
                    <div class="chart-title" style="margin-bottom:15px;">Brand Performance Matrix</div>
                    <table id="table-brands-main"><thead><tr><th>Brand</th><th>Division</th><th>Sessions</th><th>Hours</th><th>GMV</th><th>GMV/Hr</th><th>Orders</th><th>Growth</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <!-- PAGE 6: SKUS -->
            <div id="skus" class="page-section">
                 <div class="ai-panel">
                    <div class="ai-title"><i class="fa-solid fa-robot"></i> AI SKU Insight</div>
                    <div class="ai-content">
                        <ul><li>3 SKUs in Garnier range are at risk of stock-out within 48 hours based on current velocity.</li></ul>
                    </div>
                </div>
                <div class="kpi-grid" id="sku-kpi-row" style="grid-template-columns: repeat(5, 1fr);"></div>
                <div class="table-section">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <div class="chart-title">SKU Velocity & Stock</div>
                        <input type="text" placeholder="Search SKU..." style="width:200px;">
                    </div>
                    <table id="table-skus">
                        <thead><tr><th>SKU Code</th><th>Product</th><th>Brand</th><th>Price</th><th>Stock Days</th><th>Velocity</th><th>Trend</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
</div>

<!-- SKU EDIT MODAL -->
<div class="modal-overlay" id="skuModal">
    <div class="modal">
        <!-- Content same as before -->
        <div class="modal-header">
            <h3>Edit SKU Intelligence</h3>
            <button onclick="document.getElementById('skuModal').style.display='none'" style="background:none; border:none; color:#fff; cursor:pointer;">X</button>
        </div>
        <div class="modal-grid">
            <div class="form-group"><label>SKU Code</label><input type="text" value="LOR-PAR-001" readonly style="color:#666;"></div>
            <div class="form-group"><label>Brand</label><input type="text" value="L'Oréal Paris" readonly style="color:#666;"></div>
            <div class="form-group"><label>Product Name</label><input type="text" value="Revitalift Hyaluronic Acid Serum"></div>
            <div class="form-group"><label>Status</label><select><option>Active</option><option>Phase Out</option></select></div>
            <div class="form-group"><label>Selling Price (IDR)</label><input type="number" value="245000"></div>
             <div class="form-group"><label>Stock Level</label><input type="number" value="1400"></div>
        </div>
        <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
            <label style="font-size:11px; color:#aaa; display:block; margin-bottom:5px;">Performance Trend (Last 7 Days)</label>
            <div style="height:60px; width:100%; background:#0a0a0a; border:1px solid #333;">
                <canvas id="modalSparkline" style="width:100%; height:100%;"></canvas>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-gold" style="border-color:#333; color:#aaa;" onclick="document.getElementById('skuModal').style.display='none'">Cancel</button>
            <button class="btn-gold">Save Changes</button>
        </div>
    </div>
</div>

<script>
    /* ------------------------------------------------------------------
       LOGIC & DATA ENGINE
       ------------------------------------------------------------------ */
    const formatNumber = (val) => new Intl.NumberFormat('en-ID').format(val);
    const formatCurrency = (val) => {
        if (val >= 1000000000) return 'Rp ' + (val / 1000000000).toFixed(1) + 'B';
        if (val >= 1000000) return 'Rp ' + (val / 1000000).toFixed(1) + 'M';
        if (val >= 1000) return 'Rp ' + (val / 1000).toFixed(0) + 'K';
        return 'Rp ' + val;
    };

    const Brands = {
        CPD: ['L’Oréal Paris', 'Garnier', 'Maybelline', '3CE'],
        LLD: ['Lancôme', 'YSL', 'Armani', 'IT Cosmetics', 'Shu Uemura', 'Kiehl’s', 'Urban Decay'],
        PPD: ['L’Oréal Professionnel', 'Kérastase', 'Biolage', 'Matrix'],
        LDB: ['La Roche-Posay', 'CeraVe']
    };

    function renderSparkline(canvasId, dataPoints, isPositive) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 80;
        const height = canvas.height = 35;
        ctx.clearRect(0,0,width,height);
        ctx.beginPath();
        ctx.lineWidth = 2;
        ctx.strokeStyle = isPositive ? '#4caf50' : '#f44336';
        const max = Math.max(...dataPoints);
        const min = Math.min(...dataPoints);
        const range = max - min || 1;
        const step = width / (dataPoints.length - 1);
        dataPoints.forEach((val, i) => {
            const x = i * step;
            const y = height - ((val - min) / range * height);
            const safeY = 2 + (y * 0.8); 
            if(i===0) ctx.moveTo(x, safeY);
            else ctx.lineTo(x, safeY);
        });
        ctx.stroke();
        const lastY = 2 + ((height - ((dataPoints[dataPoints.length-1] - min) / range * height)) * 0.8);
        ctx.fillStyle = ctx.strokeStyle;
        ctx.beginPath();
        ctx.arc(width-3, lastY, 2, 0, Math.PI*2);
        ctx.fill();
    }

    const app = {
        currentChart: null,
        currentLiveChart: null,
        currentVideoChart: null,
        currentAffiliateChart: null,
        currentBrandChart: null,
        
        activePage: 'dashboard',
        currentPeriod: 'daily',
        currentLivePeriod: 'daily', currentLiveMetric: 'GMV',
        currentVideoPeriod: 'daily', currentVideoMetric: 'GMV',
        currentAffiliatePeriod: 'daily', currentAffiliateMetric: 'GMV',
        currentBrandPeriod: 'daily', currentBrandMetric: 'GMV',
        
        selectedDivisions: ['CPD', 'LLD', 'PPD', 'LDB'], // Default all selected

        init: function() {
            this.populateBrandFilter();
            this.generateAllData();
            this.renderDashboard();
            this.setupListeners();
        },

        populateBrandFilter: function() {
            const select = document.getElementById('brandFilter');
            select.innerHTML = '<option value="all">All Brands</option>'; 
            for (const [division, brands] of Object.entries(Brands)) {
                const group = document.createElement('optgroup');
                group.label = division;
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    group.appendChild(option);
                });
                select.appendChild(group);
            }
        },

        toggleSidebar: function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (window.innerWidth > 768) {
                sidebar.classList.toggle('desktop-hidden');
            } else {
                sidebar.classList.toggle('sidebar-open');
                overlay.classList.toggle('active');
            }
        },

        router: function(pageId, element) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            this.activePage = pageId;
            
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                sidebar.classList.remove('sidebar-open');
                overlay.classList.remove('active');
            }

            if(pageId === 'dashboard') {
                this.renderDashboard();
                this.setPeriod('daily', true);
            }
            if(pageId === 'livestream') this.renderLivestream();
            if(pageId === 'shortvideo') this.renderShortVideo();
            if(pageId === 'affiliates') this.renderAffiliates();
            if(pageId === 'brands') this.renderBrands();
            if(pageId === 'skus') this.renderSKUs();
        },

        generateAllData: function() {
            // NEW: Detailed Brand Data for Aggregation
            this.data = {
                brandsDetailed: []
            };

            // Generate detailed data for aggregation
            Object.keys(Brands).forEach(div => {
                Brands[div].forEach(brand => {
                    this.data.brandsDetailed.push({
                        name: brand,
                        division: div,
                        gmv: Math.floor(Math.random() * 500 + 100) * 10000000, 
                        sessions: Math.floor(Math.random() * 20 + 5),
                        hours: Math.floor(Math.random() * 50 + 10),
                        orders: Math.floor(Math.random() * 2000 + 500),
                        growth: Math.floor(Math.random() * 20) - 5
                    });
                });
            });

            this.data.dashboard = {
                kpis: [
                        { label: 'GMV / Hour', val: 45000000, growth: 12.5, history: [30,32,35,33,38,40,45] },
                        { label: 'Total GMV', val: 12500000000, growth: 8.4, history: [80,85,82,90,95,100,108] },
                        { label: 'Total Orders', val: 45200, growth: -2.1, history: [50,48,49,47,46,45,45] },
                        { label: 'Total Hours', val: 275, growth: 5.0, history: [20,22,25,24,26,27,28] },
                        { label: 'Total Views', val: 2400000, growth: 15.3, history: [10,12,15,18,20,22,24] },
                        { label: 'AOV', val: 276000, growth: 3.2, history: [25,25,26,26,27,27,27] }
                    ],
                engagementMetrics: [
                        { label: 'Impressions', val: '2.5M', growth: 5.4, history: [40,42,45,43,48,50,54] },
                        { label: 'Views', val: '1.2M', growth: 8.1, history: [20,22,25,24,28,30,35] },
                        { label: 'Viewers', val: '850K', growth: -2.3, history: [30,28,29,27,26,25,25] },
                        { label: 'Impression/Hr', val: '50K', growth: 12.0, history: [10,12,15,18,20,22,25] },
                        { label: 'Avg View Dur', val: '4m 12s', growth: 3.5, history: [3,3.5,4,3.8,4.1,4.2,4.2] },
                        { label: 'Comment Rate', val: '1.2%', growth: 0.5, history: [0.8,0.9,1.0,1.1,1.2,1.2,1.2] },
                        { label: 'Follow Rate', val: '0.8%', growth: -0.1, history: [1.0,0.9,0.9,0.8,0.8,0.8,0.8] },
                        { label: 'Tap-Through', val: '5.4%', growth: 2.2, history: [4,4.2,4.5,4.8,5.0,5.2,5.4] },
                        { label: 'LIVE CTR', val: '2.1%', growth: 4.5, history: [1.5,1.6,1.8,1.9,2.0,2.1,2.1] },
                        { label: 'Like Rate', val: '15%', growth: 6.0, history: [10,12,13,14,14,15,15] },
                        { label: 'Share Rate', val: '0.5%', growth: 1.1, history: [0.3,0.4,0.4,0.5,0.5,0.5,0.5] },
                        { label: 'Views > 1m', val: '450K', growth: 9.2, history: [20,25,30,35,40,42,45] },
                        { label: 'Order Rate', val: '1.8%', growth: 0.3, history: [1.5,1.6,1.6,1.7,1.7,1.8,1.8] }
                    ],
                channels: [
                        { name: 'Livestream', gmv: 7500000000, share: 67, growth: 12, history: [45,48,50,55,58,60,65] },
                        { name: 'Short Video', gmv: 3750000000, share: 33, growth: 8, history: [20,22,25,26,28,29,32] }
                    ],
                topCreators: [
                        { name: 'Tasya Farasya', gmv: 450000000 },
                        { name: 'Rachel Vennya', gmv: 320000000 },
                        { name: 'Dr. Richard Lee', gmv: 280000000 },
                        { name: 'Abel Cantika', gmv: 210000000 },
                        { name: 'Mami Louisse', gmv: 195000000 }
                    ],
                latestSessions: [
                        { time: '10 mins ago', host: 'Garnier Official', brand: 'Garnier', gmv: 12000000, gmvHr: 4500000, url: 'https://www.tiktok.com/@garnierindonesia' },
                        { time: '25 mins ago', host: 'Maybelline ID', brand: 'Maybelline', gmv: 24500000, gmvHr: 8200000, url: 'https://www.tiktok.com/@maybelline_indonesia' },
                        { time: '1 hour ago', host: 'L’Oréal Paris', brand: 'L’Oréal Paris', gmv: 56000000, gmvHr: 12500000, url: 'https://www.tiktok.com/@lorealparisid' },
                        { time: '2 hours ago', host: 'Tasya Farasya', brand: 'Luxe Mix', gmv: 185000000, gmvHr: 45000000, url: 'https://www.tiktok.com/@tasyafarasya' },
                        { time: '3 hours ago', host: 'Kérastase Pro', brand: 'Kérastase', gmv: 32000000, gmvHr: 9800000, url: 'https://www.tiktok.com/@lorealproid' }
                    ],
                livestreamHostData: [
                        { host: 'Tasya Farasya', sessions: 5, hours: 12, gmv: 2500000000, views: 150000, rpm: 450000, score: 9.8 },
                        { host: 'Mami Louisse', sessions: 8, hours: 24, gmv: 1800000000, views: 220000, rpm: 320000, score: 9.5 },
                        { host: 'Dr. Richard Lee', sessions: 4, hours: 10, gmv: 1500000000, views: 180000, rpm: 410000, score: 9.2 },
                        { host: 'Rachel Vennya', sessions: 3, hours: 8, gmv: 1200000000, views: 110000, rpm: 380000, score: 9.0 }
                    ],
                livestreamAllSessionsData: [
                        { date: '2024-01-28', time: '19:00', brand: 'L’Oréal Paris', host: 'Official Host', dur: '4h', gmv: 150000000, gmvhr: 37500000, views: 45000, imp: 120000, sold: 1200, comment: '2.5%' },
                        { date: '2024-01-27', time: '20:00', brand: 'Garnier', host: 'Guest Star', dur: '3h', gmv: 95000000, gmvhr: 31600000, views: 32000, imp: 98000, sold: 950, comment: '1.8%' },
                        { date: '2024-01-26', time: '15:00', brand: 'Maybelline', host: 'KOL A', dur: '2h', gmv: 45000000, gmvhr: 22500000, views: 18000, imp: 54000, sold: 420, comment: '1.5%' },
                        { date: '2024-01-25', time: '18:30', brand: 'Lancôme', host: 'Premium Host', dur: '5h', gmv: 450000000, gmvhr: 90000000, views: 25000, imp: 80000, sold: 550, comment: '3.2%' }
                    ],
                shortVideo: {
                        kpis: [
                            { label: 'GMV per Hour', val: 25000000, growth: 15.2, history: [18,20,22,21,23,24,25] },
                            { label: 'Video GMV', val: 3750000000, growth: 8.5, history: [40,42,41,43,44,45,46] },
                            { label: 'Total Views', val: 15400000, growth: 12.1, history: [100,110,120,115,130,140,154] },
                            { label: 'Total Orders', val: 24500, growth: 5.4, history: [18,19,20,21,22,23,24] },
                            { label: 'CTR', val: 3.8, growth: -1.2, history: [4.2,4.1,4.0,3.9,3.9,3.8,3.8], isPercent: true },
                            { label: 'AOV', val: 185000, growth: 2.5, history: [170,175,175,180,180,182,185] }
                        ],
                        breakdown: {
                            brands: [
                                { name: 'Maybelline', videos: 45, views: 5400000, likes: 450000, shares: 12000, gmv: 1200000000, er: '8.5%' },
                                { name: 'Garnier', videos: 32, views: 3200000, likes: 210000, shares: 8000, gmv: 850000000, er: '6.2%' },
                                { name: 'L’Oréal Paris', videos: 50, views: 6800000, likes: 580000, shares: 15000, gmv: 1700000000, er: '9.1%' }
                            ],
                            creators: [
                                { name: 'Tasya Farasya', videos: 12, views: 2500000, gmv: 850000000, score: 98 },
                                { name: 'Abel Cantika', videos: 8, views: 1200000, gmv: 420000000, score: 85 },
                                { name: 'Jovi Adhiguna', videos: 5, views: 950000, gmv: 350000000, score: 82 }
                            ],
                            platforms: [
                                { name: 'TikTok', views: 12500000, gmv: 2800000000, orders: 18000, ctr: '4.2%' },
                                { name: 'Shopee Video', views: 2100000, gmv: 750000000, orders: 5200, ctr: '2.8%' },
                                { name: 'Instagram Reels', views: 800000, gmv: 200000000, orders: 1300, ctr: '1.5%' }
                            ]
                        }
                    },
                affiliates: {
                        kpis: [
                            { label: 'Affiliate GMV', val: 1250000000, growth: 25.0, history: [10,12,15,18,20,22,25] },
                            { label: 'Total Orders', val: 15600, growth: 18.5, history: [12,14,15,16,17,18,19] },
                            { label: 'Commission Paid', val: 125000000, growth: 22.1, history: [8,9,10,11,12,13,14] },
                            { label: 'Active Creators', val: 450, growth: 5.5, history: [400,410,420,430,440,445,450] },
                            { label: 'Avg RPM', val: 28500, growth: -1.2, history: [30,29,29,28,28,28,28] }
                        ]
                    },
                skus: {
                        kpis: [
                            { label: 'Active SKUs', val: 1450, growth: 2.1, history: [1400,1410,1420,1430,1440,1445,1450] },
                            { label: 'Rotate Out Queue', val: 25, growth: -10.5, history: [30,28,28,27,26,25,25] },
                            { label: 'Low Stock Alerts', val: 12, growth: 50.0, history: [5,6,8,9,10,11,12] },
                            { label: 'SKU GMV (MTD)', val: 12500000000, growth: 8.4, history: [80,85,82,90,95,100,108] },
                            { label: 'Average Margin', val: 65.4, growth: 1.2, history: [64,64,65,65,65,65,65], isPercent: true }
                        ]
                    }
            };
        },

        renderDashboard: function() {
            const kpiContainer = document.getElementById('dash-kpi-row');
            kpiContainer.innerHTML = this.data.dashboard.kpis.map((k, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${k.label}</div>
                        <div class="kpi-value ${i===0?'gold':''}">${k.label.includes('GMV') || k.label.includes('AOV') ? formatCurrency(k.val) : formatNumber(k.val)}</div>
                    </div>
                    <div class="kpi-meta">
                        <div style="display:flex; flex-direction:column;">
                            <div class="kpi-growth ${k.growth>=0 ? 'growth-up' : 'growth-down'}">
                                <i class="fa-solid fa-arrow-${k.growth>=0 ? 'trend-up' : 'trend-down'}"></i>
                                ${Math.abs(k.growth)}%
                            </div>
                            <span class="kpi-subtext">vs prev period</span>
                        </div>
                        <canvas id="spk-d-${i}" class="sparkline-canvas"></canvas>
                    </div>
                </div>
            `).join('');
            this.data.dashboard.kpis.forEach((k, i) => renderSparkline(`spk-d-${i}`, k.history, k.growth >= 0));
            this.setPeriod('daily', true);
            const channelContainer = document.getElementById('channel-kpi-row');
            channelContainer.innerHTML = this.data.dashboard.channels.map((c, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${c.name}</div>
                        <div class="kpi-value">${formatCurrency(c.gmv)}</div>
                    </div>
                    <div class="kpi-meta" style="margin-bottom:15px; align-items: flex-end;">
                        <div class="kpi-growth ${c.growth>=0 ? 'growth-up' : 'growth-down'}">
                            <i class="fa-solid fa-arrow-${c.growth>=0 ? 'trend-up' : 'trend-down'}"></i>
                            ${Math.abs(c.growth)}% <span class="kpi-subtext" style="display:inline; margin-left:4px;">vs prev</span>
                        </div>
                        <canvas id="spk-c-${i}" class="sparkline-canvas" style="width: 80px; height: 35px;"></canvas>
                    </div>
                    <div style="margin-top:auto;">
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:#888; margin-bottom:6px;">
                            <span>Contribution Share</span>
                            <span style="color:#fff; font-weight:600;">${c.share}%</span>
                        </div>
                        <div style="width:100%; height:6px; background:#333; border-radius:3px;">
                            <div style="width:${c.share}%; height:100%; background:var(--color-gold); border-radius:3px; box-shadow: 0 0 10px rgba(198,166,100,0.5);"></div>
                        </div>
                    </div>
                </div>
            `).join('');
            this.data.dashboard.channels.forEach((c, i) => renderSparkline(`spk-c-${i}`, c.history, c.growth >= 0));
            const brandTable = document.querySelector('#dash-top-brands tbody');
            brandTable.innerHTML = `<tr><td><div class="rank-circle rank-1">1</div></td><td>L’Oréal Paris</td><td>Rp 2.4B</td></tr><tr><td><div class="rank-circle rank-2">2</div></td><td>Maybelline</td><td>Rp 1.8B</td></tr><tr><td><div class="rank-circle rank-3">3</div></td><td>Garnier</td><td>Rp 1.5B</td></tr><tr><td><div class="rank-circle">4</div></td><td>Lancôme</td><td>Rp 1.2B</td></tr><tr><td><div class="rank-circle">5</div></td><td>Kérastase</td><td>Rp 0.9B</td></tr>`;
            const creatorTable = document.querySelector('#dash-top-creators tbody');
            creatorTable.innerHTML = this.data.dashboard.topCreators.map((c, i) => `<tr><td><div class="rank-circle ${i===0?'rank-1':(i===1?'rank-2':(i===2?'rank-3':''))}">${i+1}</div></td><td>${c.name}</td><td>${formatCurrency(c.gmv)}</td></tr>`).join('');
            const sessionTable = document.querySelector('#dash-latest-sessions tbody');
            sessionTable.innerHTML = this.data.dashboard.latestSessions.map(s => `<tr class="clickable-row" onclick="window.open('${s.url}', '_blank')"><td><div style="color:#fff; font-weight:600;">${s.host}</div><div style="font-size:10px; color:#666;">${s.time}</div></td><td>${formatCurrency(s.gmv)}</td><td><div style="font-size:11px; color:#aaa;">GMV/Hr</div>${formatCurrency(s.gmvHr)}</td></tr>`).join('');
        },

        renderMainChart: function(canvasId, metricType, labels, dataPoints) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            if (canvasId === 'dashMainChart' && this.currentChart) this.currentChart.destroy();
            else if (canvasId === 'liveMainChart' && this.currentLiveChart) this.currentLiveChart.destroy();
            else if (canvasId === 'videoMainChart' && this.currentVideoChart) this.currentVideoChart.destroy();
            else if (canvasId === 'affiliateMainChart' && this.currentAffiliateChart) this.currentAffiliateChart.destroy();
            else if (canvasId === 'brandMainChart' && this.currentBrandChart) this.currentBrandChart.destroy();

            Chart.defaults.color = '#666';
            Chart.defaults.scale.grid.color = '#222';

            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: metricType,
                        data: dataPoints,
                        borderColor: '#C6A664',
                        backgroundColor: 'rgba(198, 166, 100, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#000',
                        pointBorderColor: '#C6A664'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true }, x: { ticks: { maxRotation: 0, autoSkip: false } } }
                }
            });

            if (canvasId === 'dashMainChart') this.currentChart = newChart;
            else if (canvasId === 'liveMainChart') this.currentLiveChart = newChart;
            else if (canvasId === 'videoMainChart') this.currentVideoChart = newChart;
            else if (canvasId === 'affiliateMainChart') this.currentAffiliateChart = newChart;
            else if (canvasId === 'brandMainChart') this.currentBrandChart = newChart;
        },

        updateChart: function(chartId, metric) {
            this.toggleBtnActive(event);
            this.setPeriod(this.currentPeriod, true);
            if(this.currentChart) { this.currentChart.data.datasets[0].label = metric; this.currentChart.update(); }
        },
        updateLiveChart: function(metric) { this.toggleBtnActive(event); this.currentLiveMetric = metric; this.setLivePeriod(this.currentLivePeriod, true); },
        updateVideoChart: function(metric) { this.toggleBtnActive(event); this.currentVideoMetric = metric; this.setVideoPeriod(this.currentVideoPeriod, true); },
        updateAffiliateChart: function(metric) { this.toggleBtnActive(event); this.currentAffiliateMetric = metric; this.setAffiliatePeriod(this.currentAffiliatePeriod, true); },
        updateBrandChart: function(metric) { this.toggleBtnActive(event); this.currentBrandMetric = metric; this.setBrandPeriod(this.currentBrandPeriod, true); },

        toggleBtnActive: function(event) {
            if(event && event.target && event.target.parentElement) {
                const parent = event.target.parentElement;
                parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
            }
        },

        generateLabelsAndData: function(period, wrapperId) {
            let labels = [];
            let count = 0;
            const wrapper = document.getElementById(wrapperId);
            if(period === 'daily') {
                count = 30;
                let date = new Date('2024-01-01');
                for(let i=0; i<count; i++) {
                    const d = date.getDate();
                    const m = date.toLocaleString('en-GB', { month: 'short' });
                    labels.push(`${d} ${m}`);
                    date.setDate(date.getDate() + 1);
                }
                if(wrapper) wrapper.style.minWidth = '1200px'; 
            } else if (period === 'weekly') {
                count = 12;
                for(let i=1; i<=count; i++) labels.push(`W${i}`);
                if(wrapper) wrapper.style.minWidth = '100%';
            } else if (period === 'monthly') {
                count = 12;
                let date = new Date('2024-01-01');
                for(let i=0; i<count; i++) {
                    const m = date.toLocaleString('en-GB', { month: 'short' });
                    labels.push(`${m}`);
                    date.setMonth(date.getMonth() + 1);
                }
                if(wrapper) wrapper.style.minWidth = '100%';
            }
            const dataPoints = Array.from({length: count}, () => Math.floor(Math.random() * 80) + 20);
            return { labels, dataPoints };
        },

        setPeriod: function(period, skipUIUpdate = false) {
            this.currentPeriod = period;
            if(!skipUIUpdate) this.toggleBtnActive(event);
            const { labels, dataPoints } = this.generateLabelsAndData(period, 'dashMainWrapper');
            this.renderMainChart('dashMainChart', 'GMV', labels, dataPoints);
        },
        setLivePeriod: function(period, skipUIUpdate = false) {
            this.currentLivePeriod = period;
            if(!skipUIUpdate) this.toggleBtnActive(event);
            const { labels, dataPoints } = this.generateLabelsAndData(period, 'liveChartWrapper');
            this.renderMainChart('liveMainChart', this.currentLiveMetric, labels, dataPoints);
        },
        setVideoPeriod: function(period, skipUIUpdate = false) {
            this.currentVideoPeriod = period;
            if(!skipUIUpdate) this.toggleBtnActive(event);
            const { labels, dataPoints } = this.generateLabelsAndData(period, 'videoChartWrapper');
            this.renderMainChart('videoMainChart', this.currentVideoMetric, labels, dataPoints);
        },
        setAffiliatePeriod: function(period, skipUIUpdate = false) {
            this.currentAffiliatePeriod = period;
            if(!skipUIUpdate) this.toggleBtnActive(event);
            const { labels, dataPoints } = this.generateLabelsAndData(period, 'affiliateChartWrapper');
            this.renderMainChart('affiliateMainChart', this.currentAffiliateMetric, labels, dataPoints);
        },
        setBrandPeriod: function(period, skipUIUpdate = false) {
            this.currentBrandPeriod = period;
            if(!skipUIUpdate) this.toggleBtnActive(event);
            const { labels, dataPoints } = this.generateLabelsAndData(period, 'brandChartWrapper');
            this.renderMainChart('brandMainChart', this.currentBrandMetric, labels, dataPoints);
        },

        renderLivestream: function() {
             const kpiContainer = document.getElementById('live-kpi-row');
             kpiContainer.innerHTML = this.data.dashboard.kpis.map((k, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${k.label}</div>
                        <div class="kpi-value ${i===0?'gold':''}">${k.label.includes('GMV') ? formatCurrency(k.val) : formatNumber(k.val)}</div>
                    </div>
                    <div class="kpi-meta">
                        <div style="display:flex; flex-direction:column;">
                             <div class="kpi-growth ${k.growth>=0 ? 'growth-up' : 'growth-down'}">${Math.abs(k.growth)}%</div>
                             <span class="kpi-subtext">vs prev</span>
                        </div>
                        <canvas id="spk-l-${i}" class="sparkline-canvas"></canvas>
                    </div>
                </div>
            `).join('');
            this.data.dashboard.kpis.forEach((k, i) => renderSparkline(`spk-l-${i}`, k.history, k.growth >= 0));
            const engagementContainer = document.getElementById('live-engagement-kpis');
            if (engagementContainer) {
                engagementContainer.innerHTML = this.data.dashboard.engagementMetrics.map((k, i) => `
                    <div class="card-compact">
                        <div class="kpi-title" style="color:#aaa;">${k.label}</div>
                        <div class="kpi-value" style="font-size:18px; margin-bottom:5px;">${k.val}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="${k.growth>=0 ? 'growth-up' : 'growth-down'}" style="font-size:10px;">${k.growth>=0?'+':''}${k.growth}%</span>
                            <canvas id="spk-e-${i}" class="sparkline-canvas"></canvas>
                        </div>
                    </div>
                `).join('');
                this.data.dashboard.engagementMetrics.forEach((k, i) => renderSparkline(`spk-e-${i}`, k.history, k.growth >= 0));
            }
            this.setLivePeriod('daily', true);
            const divTable = document.querySelector('#table-live-division tbody');
            divTable.innerHTML = ['CPD','LLD','PPD','LDB'].map(div => `<tr><td>${div}</td><td>${Math.floor(Math.random()*50+10)}</td><td>${Math.floor(Math.random()*100+20)}</td><td>Rp ${Math.floor(Math.random()*5000+1000)}M</td><td>Rp ${Math.floor(Math.random()*50+10)}M</td><td class="growth-up">+${Math.floor(Math.random()*10)}%</td></tr>`).join('');
        },
        
        switchLiveTab: function(tabName) {
            document.querySelectorAll('.live-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`live-tab-${tabName}`).classList.remove('hidden');
            this.toggleBtnActive(event);
            if(tabName === 'brand') {
                 document.querySelector('#table-live-brand tbody').innerHTML = Brands.CPD.concat(Brands.LLD).slice(0,8).map(b => `<tr><td>${b}</td><td>${Brands.CPD.includes(b)?'CPD':'LLD'}</td><td>${Math.floor(Math.random()*20)}</td><td>${Math.floor(Math.random()*50)}</td><td>Rp ${Math.floor(Math.random()*800)}M</td><td>Rp ${Math.floor(Math.random()*20)}M</td><td>${Math.floor(Math.random()*1000)}</td><td class="growth-up">+${Math.floor(Math.random()*15)}%</td></tr>`).join('');
            } else if (tabName === 'host') {
                document.querySelector('#table-live-host tbody').innerHTML = this.data.dashboard.livestreamHostData.map(h => `<tr><td>${h.host}</td><td>${h.sessions}</td><td>${h.hours}</td><td>${formatCurrency(h.gmv)}</td><td>${formatNumber(h.views)}</td><td>${formatNumber(h.rpm)}</td><td>${h.score}</td></tr>`).join('');
            } else if (tabName === 'all') {
                document.querySelector('#table-live-all tbody').innerHTML = this.data.dashboard.livestreamAllSessionsData.map(s => `<tr><td>${s.date} <br><small style="color:#666">${s.time}</small></td><td>${s.brand}</td><td>${s.host}</td><td>${s.dur}</td><td>${formatCurrency(s.gmv)}</td><td>${formatCurrency(s.gmvhr)}</td><td>${formatNumber(s.views)}</td><td>${s.comment}</td></tr>`).join('');
            }
        },

        renderShortVideo: function() {
             const kpiContainer = document.getElementById('video-kpi-row');
             kpiContainer.innerHTML = this.data.dashboard.shortVideo.kpis.map((k, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${k.label}</div>
                        <div class="kpi-value ${i===0?'gold':''}">${k.isPercent ? k.val+'%' : (k.label.includes('GMV') || k.label.includes('AOV') ? formatCurrency(k.val) : formatNumber(k.val))}</div>
                    </div>
                    <div class="kpi-meta">
                        <div style="display:flex; flex-direction:column;">
                             <div class="kpi-growth ${k.growth>=0 ? 'growth-up' : 'growth-down'}">${k.growth>=0?'+':''}${k.growth}%</div>
                             <span class="kpi-subtext">vs prev period</span>
                        </div>
                        <canvas id="spk-v-${i}" class="sparkline-canvas"></canvas>
                    </div>
                </div>
             `).join('');
             this.data.dashboard.shortVideo.kpis.forEach((k, i) => renderSparkline(`spk-v-${i}`, k.history, k.growth >= 0));
             this.setVideoPeriod('daily', true);
             this.switchShortVideoTab('brand');
        },

        switchShortVideoTab: function(tabName) {
            document.querySelectorAll('.video-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`video-tab-${tabName}`).classList.remove('hidden');
            this.toggleBtnActive(event);
            if(tabName === 'brand') {
                document.querySelector('#table-video-brand tbody').innerHTML = this.data.dashboard.shortVideo.breakdown.brands.map(b => `<tr><td>${b.name}</td><td>${b.videos}</td><td>${formatNumber(b.views)}</td><td>${formatNumber(b.likes)}</td><td>${formatNumber(b.shares)}</td><td>${formatCurrency(b.gmv)}</td><td>${b.er}</td></tr>`).join('');
            } else if (tabName === 'creator') {
                document.querySelector('#table-video-creator tbody').innerHTML = this.data.dashboard.shortVideo.breakdown.creators.map(c => `<tr><td>${c.name}</td><td>${c.videos}</td><td>${formatNumber(c.views)}</td><td>${formatCurrency(c.gmv)}</td><td>${c.score}</td></tr>`).join('');
            } else if (tabName === 'platform') {
                document.querySelector('#table-video-platform tbody').innerHTML = this.data.dashboard.shortVideo.breakdown.platforms.map(p => `<tr><td>${p.name}</td><td>${formatNumber(p.views)}</td><td>${formatCurrency(p.gmv)}</td><td>${formatNumber(p.orders)}</td><td>${p.ctr}</td></tr>`).join('');
            }
        },

        renderAffiliates: function() {
             const kpiContainer = document.getElementById('affiliate-kpi-row');
             kpiContainer.innerHTML = this.data.dashboard.affiliates.kpis.map((k, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${k.label}</div>
                        <div class="kpi-value ${i===0?'gold':''}">${k.label.includes('GMV') || k.label.includes('Commission') || k.label.includes('RPM') ? formatCurrency(k.val) : formatNumber(k.val)}</div>
                    </div>
                    <div class="kpi-meta">
                        <div style="display:flex; flex-direction:column;">
                             <div class="kpi-growth ${k.growth>=0 ? 'growth-up' : 'growth-down'}">${k.growth>=0?'+':''}${k.growth}%</div>
                             <span class="kpi-subtext">vs prev period</span>
                        </div>
                        <canvas id="spk-a-${i}" class="sparkline-canvas"></canvas>
                    </div>
                </div>
             `).join('');
             this.data.dashboard.affiliates.kpis.forEach((k, i) => renderSparkline(`spk-a-${i}`, k.history, k.growth >= 0));
             this.setAffiliatePeriod('daily', true);
             document.querySelector('#table-affiliates tbody').innerHTML = [{name: 'Tasya Farasya', plat: 'TikTok', gmv: 450, comm: 8},{name: 'Rachel Vennya', plat: 'Shopee', gmv: 320, comm: 7},{name: 'Dr. Richard Lee', plat: 'TikTok', gmv: 280, comm: 6}].map((c, i) => `<tr><td>${i+1}</td><td>${c.name}</td><td>${c.plat}</td><td>Rp ${c.gmv}M</td><td>${Math.floor(c.gmv*1000)}</td><td>${c.comm}%</td><td>150K</td><td class="growth-up">+5%</td></tr>`).join('');
        },

        // TOGGLE BRAND FILTER FUNCTION
        toggleBrandFilter: function(division) {
            const index = this.selectedDivisions.indexOf(division);
            if (index > -1) {
                // If already selected, remove it (deselect)
                this.selectedDivisions.splice(index, 1);
            } else {
                // If not selected, add it (select)
                this.selectedDivisions.push(division);
            }
            
            this.updateBrandDashboard();
        },
        
        // NEW: AGGREGATE FUNCTION
        updateBrandDashboard: function() {
            // 1. FILTER DATA
            let filteredBrands = [];
            // If nothing selected, assume ALL
            const divisionsToUse = this.selectedDivisions.length > 0 ? this.selectedDivisions : ['CPD', 'LLD', 'PPD', 'LDB'];

            filteredBrands = this.data.brandsDetailed.filter(b => divisionsToUse.includes(b.division));

            // 2. AGGREGATE KPI
            let totalGMV = 0;
            let totalSessions = 0;
            let totalHours = 0;
            let totalOrders = 0;
            let brandCount = filteredBrands.length;

            filteredBrands.forEach(b => {
                totalGMV += b.gmv;
                totalSessions += b.sessions;
                totalHours += b.hours;
                totalOrders += b.orders;
            });

            const avgGMV = brandCount > 0 ? totalGMV / brandCount : 0;
            const avgSessions = brandCount > 0 ? totalSessions / brandCount : 0;
            const gmvPerHour = totalHours > 0 ? totalGMV / totalHours : 0;

            // 3. RENDER SECONDARY KPIs (Dynamic)
            const kpiData = [
                { label: 'Total Brand Count', val: brandCount, growth: 0 },
                { label: 'Active Brands', val: Math.floor(brandCount * 0.9), growth: 5 }, // Fake logic
                { label: 'Total Brand GMV', val: totalGMV, growth: 8 },
                { label: 'Avg Session/Brand', val: Math.floor(avgSessions), growth: 12 },
                { label: 'Avg GMV/Brand', val: avgGMV, growth: 7 }
            ];

            const kpiContainer = document.getElementById('brand-kpi-row');
            kpiContainer.innerHTML = kpiData.map((k, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${k.label}</div>
                        <div class="kpi-value ${i===2?'gold':''}">${k.label.includes('GMV') ? formatCurrency(k.val) : formatNumber(k.val)}</div>
                    </div>
                    <div class="kpi-meta">
                        <div style="display:flex; flex-direction:column;">
                             <div class="kpi-growth ${k.growth>=0 ? 'growth-up' : 'growth-down'}">${k.growth>=0?'+':''}${k.growth}%</div>
                             <span class="kpi-subtext">vs prev period</span>
                        </div>
                        <canvas id="spk-b-${i}" class="sparkline-canvas"></canvas>
                    </div>
                </div>
            `).join('');
            // Add dummy sparklines
            kpiData.forEach((k, i) => renderSparkline(`spk-b-${i}`, [10,20,15,25,30,28,35], k.growth >= 0));

            // 4. UPDATE CARDS UI (Selection State)
            const container = document.getElementById('brand-division-cards');
            // Re-rendering cards might be overkill if we just want to toggle class, but ensures consistency
            const divisions = [
                {code: 'CPD', name: 'Consumer Products (CPD)'},
                {code: 'LLD', name: 'L’Oréal Luxe (LLD)'},
                {code: 'PPD', name: 'Professional (PPD)'},
                {code: 'LDB', name: 'Dermatological (LDB)'}
            ];

            container.innerHTML = divisions.map((div, i) => {
                const isSelected = this.selectedDivisions.includes(div.code);
                // Calculate Division Totals for Card Stats
                const divBrands = this.data.brandsDetailed.filter(b => b.division === div.code);
                let dGMV = 0, dSessions = 0, dHours = 0;
                divBrands.forEach(b => { dGMV += b.gmv; dSessions += b.sessions; dHours += b.hours; });
                
                return `
                <div class="division-card ${isSelected ? 'selected' : ''}" onclick="app.toggleBrandFilter('${div.code}')">
                    <div class="card-checkbox"></div>
                    <div class="div-title">${div.name}</div>
                    <div class="div-stat"><span>GMV</span> <span class="div-metric-lg">${formatCurrency(dGMV)}</span></div>
                    <div class="div-stat"><span>GMV/hr</span> <span>${formatCurrency(dHours > 0 ? dGMV/dHours : 0)}</span></div>
                    <div class="div-stat"><span>Sessions</span> <span>${dSessions}</span></div>
                    <div class="div-stat"><span>GMV Growth</span> <span class="growth-up">+12%</span></div>
                </div>
            `}).join('');

            // 5. UPDATE TABLE
            const tbody = document.querySelector('#table-brands-main tbody');
            tbody.innerHTML = filteredBrands.map(b => `
                <tr>
                    <td>${b.name}</td>
                    <td>${b.division}</td>
                    <td>${b.sessions}</td>
                    <td>${b.hours}</td>
                    <td>${formatCurrency(b.gmv)}</td>
                    <td>${formatCurrency(b.hours > 0 ? b.gmv/b.hours : 0)}</td>
                    <td>${formatNumber(b.orders)}</td>
                    <td class="${b.growth>0?'growth-up':'growth-down'}">${b.growth>0?'+':''}${b.growth}%</td>
                </tr>
            `).join('');

            // 6. UPDATE CHART (Simulated)
            // Just trigger a re-render with "different" random data to show interaction
            this.setBrandPeriod(this.currentBrandPeriod, true);
        },

        renderBrands: function() {
            // Initial render wrapper
            this.updateBrandDashboard();
            this.setBrandPeriod('daily', true);
        },

        renderSKUs: function() {
            const kpiContainer = document.getElementById('sku-kpi-row');
            kpiContainer.innerHTML = this.data.dashboard.skus.kpis.map((k, i) => `
                <div class="card">
                    <div>
                        <div class="kpi-title">${k.label}</div>
                        <div class="kpi-value ${i===3?'gold':''}">${k.isPercent ? k.val+'%' : (k.label.includes('GMV') ? formatCurrency(k.val) : formatNumber(k.val))}</div>
                    </div>
                    <div class="kpi-meta">
                        <div style="display:flex; flex-direction:column;">
                             <div class="kpi-growth ${k.growth>=0 ? 'growth-up' : 'growth-down'}">${k.growth>=0?'+':''}${k.growth}%</div>
                             <span class="kpi-subtext">vs prev period</span>
                        </div>
                        <canvas id="spk-s-${i}" class="sparkline-canvas"></canvas>
                    </div>
                </div>
            `).join('');
            this.data.dashboard.skus.kpis.forEach((k, i) => renderSparkline(`spk-s-${i}`, k.history, k.growth >= 0));

            document.querySelector('#table-skus tbody').innerHTML = [{code: 'LOR-PAR-001', name: 'Revitalift Serum', brand: 'L’Oréal Paris', price: 245000},{code: 'MAY-MAT-023', name: 'Super Stay Matte Ink', brand: 'Maybelline', price: 125000},{code: 'GAR-MIC-005', name: 'Micellar Water Pink', brand: 'Garnier', price: 45000},{code: 'LAN-ADV-001', name: 'Advanced Génifique', brand: 'Lancôme', price: 1450000},{code: 'KER-ELI-010', name: 'Elixir Ultime Oil', brand: 'Kérastase', price: 560000}].map(sku => `
                <tr onclick="document.getElementById('skuModal').style.display='flex'; renderSparkline('modalSparkline', [5,8,6,9,12,10,14], true)">
                    <td>${sku.code}</td><td>${sku.name}</td><td>${sku.brand}</td><td>Rp ${formatNumber(sku.price)}</td><td>${Math.floor(Math.random()*30+2)} days</td><td><div style="width:80%; background:#333; height:4px;"><div style="width:${Math.random()*100}%; background:var(--color-gold); height:100%;"></div></div></td><td><span class="growth-up"><i class="fa-solid fa-arrow-trend-up"></i></span></td><td><button class="btn-gold" style="font-size:9px; padding:2px 6px;">EDIT</button></td>
                </tr>
            `).join('');
        },

        setupListeners: function() { }
    };

    window.addEventListener('DOMContentLoaded', () => {
        app.init();
    });

</script>
</body>
</html>
